---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
      options: "{{ molecule_yml.driver.options }}"
  tasks:
    - name: "Load proxmox secrets."
      ansible.builtin.include_tasks: tasks/secrets.yml
      when: options.proxmox_secrets is defined

    - name: "Clear instance configs."
      ansible.builtin.set_fact:
        instance_configs: []

    - name: "Create molecule instance(s)."
      ansible.builtin.include_tasks: tasks/create_kvm.yml
      loop: "{{ molecule_yml.platforms }}"
      loop_control:
        loop_var: p
        label: "{{ p.name }}"

    - name: "Write instance configs."
      ansible.builtin.copy:
        content: "{{ instance_configs | to_nice_yaml }}"
        dest: "{{ molecule_instance_config }}"
        mode: '0644'
